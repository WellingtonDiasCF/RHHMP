{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Saídas - {{ empresa_selecionada }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; }
        th a { color: #333; text-decoration: none; display: block; width: 100%; transition: color 0.2s; }
        th a:hover { color: #dc3545; }
        th i { font-size: 0.8em; margin-left: 5px; opacity: 0.5; }
        th a i.fa-sort-up, th a i.fa-sort-down { opacity: 1; color: #dc3545; }
        
        #loading-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.7); z-index: 10; justify-content: center; align-items: center; border-radius: 12px;
        }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-danger mb-4 shadow-sm">
        <div class="container px-4">
            <span class="navbar-brand fw-bold"><i class="fas fa-dolly-flatbed me-2"></i> Relatório de Saídas</span>
            <div>
                <a href="{% url 'estoque_pecas_dashboard' %}?estoque={{ empresa_selecionada }}" class="btn btn-sm btn-outline-light me-2">Painel</a>
                <a href="{% url 'retirada_peca' %}?estoque={{ empresa_selecionada }}" class="btn btn-sm btn-light text-danger fw-bold"><i class="fas fa-plus"></i> Nova Saída</a>
            </div>
        </div>
    </nav>

    <div class="container px-4">
        
        <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body py-2">
                <form class="d-flex gap-2 align-items-end flex-wrap">
                    <input type="hidden" name="estoque" value="{{ empresa_selecionada }}">
                    
                    <div class="col-md-4">
                        <label class="small fw-bold text-muted">Pesquisar</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-white"><i class="fas fa-search text-danger"></i></span>
                            <input type="text" id="search-input" name="q" class="form-control" 
                                   placeholder="Técnico, Material, Chamado..." value="{{ request.GET.q }}" autocomplete="off">
                        </div>
                    </div>

                    <div class="col-md-2">
                        <label class="small fw-bold text-muted">Data Início</label>
                        <input type="date" name="data_inicio" class="form-control form-control-sm" value="{{ request.GET.data_inicio }}">
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold text-muted">Data Fim</label>
                        <input type="date" name="data_fim" class="form-control form-control-sm" value="{{ request.GET.data_fim }}">
                    </div>
                    
                    <div class="col-md-4 d-flex gap-2 justify-content-end">
                        <button type="submit" class="btn btn-danger btn-sm px-3 fw-bold">Filtrar Data</button>
                        <a href="?estoque={{ empresa_selecionada }}" class="btn btn-outline-secondary btn-sm px-3">Limpar</a>
                        <a href="?estoque={{ empresa_selecionada }}&export=xls&data_inicio={{ request.GET.data_inicio }}&data_fim={{ request.GET.data_fim }}&q={{ request.GET.q }}" class="btn btn-success btn-sm fw-bold">
                            <i class="fas fa-file-excel me-1"></i> Excel
                        </a>
                    </div>
                </form>
            </div>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm">
                    {{ message }} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <div class="card border-0 shadow rounded-4 position-relative">
            <div id="loading-overlay">
                <div class="spinner-border text-danger" role="status"><span class="visually-hidden">...</span></div>
            </div>

            <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0 text-secondary">Histórico de Movimentações</h5>
                <span class="badge bg-danger">{{ empresa_selecionada }}</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">
                                    <a href="?estoque={{ empresa_selecionada }}&order={% if request.GET.order == 'data' %}-data{% else %}data{% endif %}&q={{ request.GET.q }}&data_inicio={{ request.GET.data_inicio }}&data_fim={{ request.GET.data_fim }}">
                                        Data {% if request.GET.order == 'data' %}<i class="fas fa-sort-up"></i>{% elif request.GET.order == '-data' %}<i class="fas fa-sort-down"></i>{% else %}<i class="fas fa-sort"></i>{% endif %}
                                    </a>
                                </th>
                                <th>
                                    <a href="?estoque={{ empresa_selecionada }}&order={% if request.GET.order == 'tecnico_nome' %}-tecnico_nome{% else %}tecnico_nome{% endif %}&q={{ request.GET.q }}&data_inicio={{ request.GET.data_inicio }}&data_fim={{ request.GET.data_fim }}">
                                        Técnico / Destino {% if request.GET.order == 'tecnico_nome' %}<i class="fas fa-sort-up"></i>{% elif request.GET.order == '-tecnico_nome' %}<i class="fas fa-sort-down"></i>{% else %}<i class="fas fa-sort"></i>{% endif %}
                                    </a>
                                </th>
                                <th>
                                    <a href="?estoque={{ empresa_selecionada }}&order={% if request.GET.order == 'peca__nome' %}-peca__nome{% else %}peca__nome{% endif %}&q={{ request.GET.q }}&data_inicio={{ request.GET.data_inicio }}&data_fim={{ request.GET.data_fim }}">
                                        Material {% if request.GET.order == 'peca__nome' %}<i class="fas fa-sort-up"></i>{% elif request.GET.order == '-peca__nome' %}<i class="fas fa-sort-down"></i>{% else %}<i class="fas fa-sort"></i>{% endif %}
                                    </a>
                                </th>
                                <th class="text-center">
                                    <a href="?estoque={{ empresa_selecionada }}&order={% if request.GET.order == 'quantidade' %}-quantidade{% else %}quantidade{% endif %}&q={{ request.GET.q }}&data_inicio={{ request.GET.data_inicio }}&data_fim={{ request.GET.data_fim }}">
                                        Qtd {% if request.GET.order == 'quantidade' %}<i class="fas fa-sort-up"></i>{% elif request.GET.order == '-quantidade' %}<i class="fas fa-sort-down"></i>{% else %}<i class="fas fa-sort"></i>{% endif %}
                                    </a>
                                </th>
                                <th class="text-end">
                                    <a href="?estoque={{ empresa_selecionada }}&order={% if request.GET.order == 'valor_total' %}-valor_total{% else %}valor_total{% endif %}&q={{ request.GET.q }}&data_inicio={{ request.GET.data_inicio }}&data_fim={{ request.GET.data_fim }}">
                                        Valor Total {% if request.GET.order == 'valor_total' %}<i class="fas fa-sort-up"></i>{% elif request.GET.order == '-valor_total' %}<i class="fas fa-sort-down"></i>{% else %}<i class="fas fa-sort"></i>{% endif %}
                                    </a>
                                </th>
                                <th class="text-center">NF-e</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-conteudo">
                            {% for m in movimentacoes %}
                            <tr>
                                <td class="ps-4">
                                    <div class="fw-bold text-dark">{{ m.data|date:"d/m/Y" }}</div>
                                    <small class="text-muted">Chamado: {{ m.numero_chamado|default:"-" }}</small>
                                </td>
                                <td>
                                    <div class="fw-bold">{{ m.tecnico_nome|default:"Não informado" }}</div>
                                    <small class="text-muted">{{ m.filial|default:"-" }}</small>
                                </td>
                                <td>
                                    <div class="text-dark fw-bold">{{ m.peca.nome }}</div>
                                    <small class="text-muted">#{{ m.peca.codigo_material }}</small>
                                </td>
                                <td class="text-center"><span class="badge bg-secondary rounded-pill">{{ m.quantidade }}</span></td>
                                <td class="text-end fw-bold text-success">R$ {{ m.valor_total_db|default:m.valor_total|floatformat:2 }}</td>
                                <td class="text-center">
                                    {% if m.url_pdf_nfe and m.url_pdf_nfe != '#' %}
                                        <a href="{{ m.url_pdf_nfe }}" target="_blank" class="btn btn-sm btn-outline-danger py-0" title="Baixar NF"><i class="fas fa-file-pdf"></i> PDF</a>
                                        <div style="font-size: 10px;" class="text-muted mt-1">Autorizada</div>
                                    {% elif m.status_nfe == 'Erro na Emissão' %}
                                        <span class="badge bg-warning text-dark" title="{{ m.mensagem_sefaz }}">Erro</span>
                                    {% else %}
                                        <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-5 text-muted">
                                    <i class="fas fa-search fa-2x mb-3 text-secondary opacity-25"></i><br>
                                    Nenhuma saída encontrada.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-light text-end fw-bold">
                Total do Período: <span class="text-success ms-2">R$ {{ total_periodo|floatformat:2 }}</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const searchInput = document.getElementById("search-input");
            const tabelaConteudo = document.getElementById("tabela-conteudo");
            const loadingOverlay = document.getElementById("loading-overlay");
            let timeout = null;

            searchInput.addEventListener("input", function(e) {
                clearTimeout(timeout);
                loadingOverlay.style.display = "flex";
                timeout = setTimeout(() => {
                    const url = new URL(window.location.href);
                    url.searchParams.set("q", e.target.value);
                    fetch(url).then(response => response.text()).then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, "text/html");
                        tabelaConteudo.innerHTML = doc.getElementById("tabela-conteudo").innerHTML;
                        loadingOverlay.style.display = "none";
                        window.history.pushState({}, "", url);
                    }).catch(err => { console.error(err); loadingOverlay.style.display = "none"; });
                }, 500);
            });
        });
    </script>
</body>
</html>