{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Ponto | Portal RH</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Inter', sans-serif;
            color: #333;
            min-height: 100vh;
            padding-bottom: 100px;
        }

        /* Navbar Padrão */
        .navbar-custom {
            background: linear-gradient(to right, #1a1a1a, #333);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* Layout */
        .page-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .header-box {
            background: #fff;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        /* Inputs da Tabela */
        .form-control-time {
            border: 1px solid #dee2e6;
            text-align: center;
            font-size: 0.9rem;
            padding: 4px;
            border-radius: 6px;
            width: 100%;
            min-width: 70px;
            background-color: #fff;
        }
        .form-control-time:focus {
            border-color: #FF6600;
            box-shadow: 0 0 0 0.2rem rgba(255, 102, 0, 0.15);
            background-color: #fff !important;
        }
        .input-obs {
            font-size: 0.85rem;
            border-radius: 6px;
        }

        /* --- ESTILOS DE LINHA E CORES --- */

        /* 1. FIM DE SEMANA (Cinza) */
        .row-weekend td { 
            background-color: #949191ff !important; 
            color: #000000ff;
        }

        /* 2. FERIADO (Verde Claro) */
        .row-feriado td { 
            background-color: #d1e7dd !important; 
            color: #0f5132;
        }

        /* 3. ATESTADO DE DIAS (Vermelho Claro) */
        .row-atestado-dias td { 
            background-color: #fee2e2 !important; 
            color: #000000ff;
        }

        /* 4. ATESTADO DE HORAS (Amarelo Claro) */
        .row-atestado-horas td { 
            background-color: #fef9c3 !important; 
            color: #000000ff;
        }

        /* 5. FÉRIAS (Azul Claro) */
        .row-ferias td {
            background-color: #cff4fc !important; /* Ciano/Azul suave Bootstrap */
            color: #055160;
        }

        /* Deixa os inputs transparentes nessas linhas */
        .row-weekend input, 
        .row-feriado input, 
        .row-atestado-dias input,
        .row-atestado-horas input,
        .row-ferias input {
            background-color: transparent !important;
            border-color: rgba(0,0,0,0.1);
        }

        /* Badges */
        .badge-feriado { background: #198754; color: white; }
        .badge-atestado-dias { background: #ff0000ff; color: white; }
        .badge-atestado-horas { background: #757e02ff; color: white; }
        .badge-ferias { background: #0dcaf0; color: black; } /* Azul Ciano */

        /* Cores Específicas para o Texto da Observação */
        .obs-feriado { color: #198754 !important; font-weight: bold; }
        .obs-atestado-dias { color: #ff0000ff !important; font-weight: bold; font-style: italic; }
        .obs-atestado-horas { color: #757e02ff !important; font-weight: bold; }
        .obs-ferias { color: #0aa2c0 !important; font-weight: bold; } /* Um azul um pouco mais escuro para ler melhor */

        /* Tabela expandida */
        .table-responsive { overflow: visible; }
        
        /* Cabeçalho Sticky */
        thead th {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding-top: 15px;
            padding-bottom: 15px;
        }

        /* Botão Flutuante */
        .floating-save-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex;
            gap: 15px;
            z-index: 1000;
            border: 1px solid rgba(0,0,0,0.05);
        }
    </style>
</head>
<body data-ent-padrao="{{ funcionario.jornada_entrada|date:'H' }}"
      data-sai-padrao="{{ funcionario.jornada_saida|date:'H' }}"
      data-intervalo="{{ funcionario.intervalo_padrao }}">

    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="{% url 'home' %}">
                <i class="fas fa-clock me-2 text-warning"></i> Portal RH <span class="fw-light text-white-50">| Ponto</span>
            </a>
            <div class="d-flex align-items-center gap-3">
                <span class="text-white small d-none d-md-block">Olá, {{ request.user.first_name }}</span>
                <a href="{% url 'home' %}" class="btn btn-sm btn-outline-light rounded-pill px-3">Início</a>
            </div>
        </div>
    </nav>

    <div class="page-container">
        
        <div class="header-box">
            <div>
                <h3 class="fw-bold text-dark mb-1">Folha de Ponto</h3>
                <div class="d-flex align-items-center gap-3 mt-2">
                    {% if prev_mes %}
                        <a href="?mes={{ prev_mes }}&ano={{ prev_ano }}" class="btn btn-sm btn-light border rounded-pill">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    {% endif %}
                    
                    <span class="fw-bold text-primary fs-5" style="min-width: 150px; text-align: center;">
                        {{ nome_mes }}
                    </span>

                    {% if next_mes %}
                        <a href="?mes={{ next_mes }}&ano={{ next_ano }}" class="btn btn-sm btn-light border rounded-pill">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    {% endif %}
                </div>
            </div>

            <div class="d-flex gap-2 flex-wrap justify-content-end align-self-center">
                {% if not is_locked %}
                    <button type="submit" form="ponto-form" class="btn btn-success rounded-pill px-4 fw-bold shadow-sm">
                        <i class="fas fa-save me-2"></i> Salvar
                    </button>
                {% else %}
                    <button disabled class="btn btn-secondary rounded-pill px-4 fw-bold">
                        <i class="fas fa-lock me-2"></i> Fechado
                    </button>
                {% endif %}

                <a href="{% url 'gerar_pdf_ponto' %}?mes={{ mes_atual }}&ano={{ ano_atual }}" target="_blank" class="btn btn-outline-danger rounded-pill px-4 fw-bold">
                    <i class="fas fa-file-pdf me-2"></i> PDF
                </a>

                {% if not is_locked %}
                    <button type="button" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#modalAssinatura">
                        <i class="fas fa-file-signature me-2"></i> Assinar
                    </button>
                {% endif %}
            </div>

            <div class="w-100 d-flex flex-wrap gap-4 mt-3 pt-3 border-top">
                <div class="d-flex align-items-center" title="Dias não úteis">
                    <span class="rounded-circle border me-2 shadow-sm" style="width: 14px; height: 14px; background-color: #6d6a6aff;"></span>
                    <small class="text-muted fw-bold" style="font-size: 0.8rem;">Fim de Semana</small>
                </div>
                <div class="d-flex align-items-center" title="Feriados Nacionais/Estaduais">
                    <span class="rounded-circle border me-2 shadow-sm" style="width: 14px; height: 14px; background-color: #198754;"></span>
                    <small class="text-muted fw-bold" style="font-size: 0.8rem;">Feriado</small>
                </div>
                <div class="d-flex align-items-center" title="Afastamento por atestado médico (Dias)">
                    <span class="rounded-circle border me-2 shadow-sm" style="width: 14px; height: 14px; background-color: #ff0000ff;"></span>
                    <small class="text-muted fw-bold" style="font-size: 0.8rem;">Atestado (Afastamento)</small>
                </div>
                <div class="d-flex align-items-center" title="Declaração de comparecimento (Horas)">
                    <span class="rounded-circle border me-2 shadow-sm" style="width: 14px; height: 14px; background-color: #757e02ff;"></span>
                    <small class="text-muted fw-bold" style="font-size: 0.8rem;">Comparecimento (Horas)</small>
                </div>
                <div class="d-flex align-items-center" title="Período de Férias">
                    <span class="rounded-circle border me-2 shadow-sm" style="width: 14px; height: 14px; background-color: #0dcaf0;"></span>
                    <small class="text-muted fw-bold" style="font-size: 0.8rem;">Férias</small>
                </div>
            </div>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} border-0 shadow-sm rounded-4 mb-4">
                    <i class="fas fa-info-circle me-2"></i> {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <div class="card border-0 shadow-sm rounded-4 bg-white">
            <div class="table-responsive">
                <form method="post" action="{% url 'salvar_ponto' %}" id="ponto-form">
                    {% csrf_token %}
                    <input type="hidden" name="mes" value="{{ mes_atual }}">
                    <input type="hidden" name="ano" value="{{ ano_atual }}">

                    <table class="table table-hover mb-0 align-middle">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 text-secondary">Dia</th>
                                <th class="text-center text-secondary">Entrada</th>
                                <th class="text-center text-secondary">Almoço Sai</th>
                                <th class="text-center text-secondary">Almoço Volta</th>
                                <th class="text-center text-secondary">Saída</th>
                                <th class="text-center text-primary bg-primary-subtle border-start">Ent. Extra</th>
                                <th class="text-center text-primary bg-primary-subtle">Sai. Extra</th>
                                <th class="pe-4 text-secondary">Observações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dia in dias_do_mes %}
                                {% with reg=dia.registro %}
                                <tr class="
                                    {% if dia.eh_ferias %}row-ferias
                                    {% elif dia.tipo_atestado == 'DIAS' %}row-atestado-dias
                                    {% elif dia.tipo_atestado == 'HORAS' %}row-atestado-horas
                                    {% elif dia.eh_feriado %}row-feriado
                                    {% elif dia.eh_fim_de_semana %}row-weekend{% endif %}
                                ">
                                    <td class="ps-4">
                                        <div class="d-flex flex-column">
                                            <span class="fw-bold fs-5">{{ dia.data.day }}</span>
                                            <small class="text-uppercase" style="font-size: 0.7rem;">{{ dia.dia_semana_nome }}</small>
                                            
                                            {% if dia.eh_ferias %}
                                                <span class="badge badge-ferias rounded-pill mt-1">FÉRIAS</span>
                                            {% elif dia.eh_feriado %}
                                                <span class="badge badge-feriado rounded-pill mt-1">FERIADO</span>
                                            {% elif dia.tipo_atestado == 'DIAS' %}
                                                <span class="badge badge-atestado-dias rounded-pill mt-1">ATESTADO</span>
                                            {% elif dia.tipo_atestado == 'HORAS' %}
                                                <span class="badge badge-atestado-horas rounded-pill mt-1" style="font-size: 0.65rem;">COMPARECIMENTO</span>
                                            {% endif %}
                                        </div>
                                    </td>

                                    {% if dia.eh_ferias or dia.tipo_atestado == 'DIAS' %}
                                        <td class="text-center text-muted">-</td>
                                        <td class="text-center text-muted">-</td>
                                        <td class="text-center text-muted">-</td>
                                        <td class="text-center text-muted">-</td>
                                        <td class="text-center text-muted border-start">-</td>
                                        <td class="text-center text-muted">-</td>
                                    
                                    {% else %}
                                        <td class="p-1"><input type="time" name="entrada_1_{{ dia.data.day }}" value="{{ reg.entrada_manha|date:'H:i'|default:'' }}" class="form-control form-control-time" {% if is_locked %}disabled{% endif %}></td>
                                        <td class="p-1"><input type="time" name="saida_1_{{ dia.data.day }}" value="{{ reg.saida_almoco|date:'H:i'|default:'' }}" class="form-control form-control-time" {% if is_locked %}disabled{% endif %}></td>
                                        <td class="p-1"><input type="time" name="entrada_2_{{ dia.data.day }}" value="{{ reg.volta_almoco|date:'H:i'|default:'' }}" class="form-control form-control-time" {% if is_locked %}disabled{% endif %}></td>
                                        <td class="p-1"><input type="time" name="saida_2_{{ dia.data.day }}" value="{{ reg.saida_tarde|date:'H:i'|default:'' }}" class="form-control form-control-time" {% if is_locked %}disabled{% endif %}></td>
                                        
                                        <td class="p-1 border-start"><input type="time" name="entrada_extra_{{ dia.data.day }}" value="{{ reg.extra_entrada|date:'H:i'|default:'' }}" class="form-control form-control-time fw-bold" {% if is_locked %}disabled{% endif %}></td>
                                        <td class="p-1"><input type="time" name="saida_extra_{{ dia.data.day }}" value="{{ reg.extra_saida|date:'H:i'|default:'' }}" class="form-control form-control-time fw-bold" {% if is_locked %}disabled{% endif %}></td>
                                    {% endif %}

                                    <td class="pe-4 p-1" style="min-width: 200px;">
                                        <input type="text" name="observacoes_{{ dia.data.day }}" 
                                               value="{{ dia.obs_visual }}" 
                                               class="form-control input-obs 
                                               {% if dia.eh_ferias %}bg-transparent border-0 obs-ferias
                                               {% elif dia.tipo_atestado == 'DIAS' %}bg-transparent border-0 obs-atestado-dias
                                               {% elif dia.tipo_atestado == 'HORAS' %}bg-transparent border-0 obs-atestado-horas
                                               {% elif dia.eh_feriado %}bg-transparent border-0 obs-feriado{% endif %}"
                                               {% if is_locked or dia.eh_ferias or dia.tipo_atestado == 'DIAS' or dia.eh_feriado %}readonly{% endif %}
                                               placeholder="Obs...">
                                    </td>
                                </tr>
                                {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    <div class="p-4 bg-light border-top text-end">
                        <button type="submit" class="btn btn-success rounded-pill px-5 fw-bold">
                            <i class="fas fa-save me-2"></i> Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if not is_locked %}
    <div class="floating-save-bar">
        <span class="text-muted align-self-center small d-none d-md-block">Não esqueça de salvar seu progresso</span>
        <button type="submit" form="ponto-form" class="btn btn-success rounded-pill px-4 fw-bold shadow-sm">
            <i class="fas fa-save me-2"></i> Salvar
        </button>
    </div>
    {% endif %}

    <div class="modal fade" id="modalAssinatura" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold"><i class="fas fa-file-signature me-2 text-primary"></i> Assinar Folha</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    
                    <div class="d-grid mb-4">
                        <a href="{% url 'gerar_pdf_ponto' %}?mes={{ mes_atual }}&ano={{ ano_atual }}" class="btn btn-outline-danger py-2 fw-bold">
                            <i class="fas fa-download me-2"></i> 1. Baixar Folha em PDF
                        </a>
                    </div>

                    <ol class="list-group list-group-numbered mb-4 small text-muted">
                        <li class="list-group-item border-0 p-1">Após baixar o arquivo acima...</li>
                        <li class="list-group-item border-0 p-1">Acesse o <a href="https://assinador.iti.br" target="_blank" class="fw-bold">Gov.br (Assinador)</a>.</li>
                        <li class="list-group-item border-0 p-1">Assine digitalmente e salve o arquivo.</li>
                        <li class="list-group-item border-0 p-1">Envie o arquivo assinado (.p7s ou .pdf) abaixo:</li>
                    </ol>
                    
                    <form action="{% url 'salvar_ponto' %}" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="mes" value="{{ mes_atual }}">
                        <input type="hidden" name="ano" value="{{ ano_atual }}">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-secondary">Arquivo Assinado</label>
                            <input type="file" name="pdf_assinado" class="form-control" accept=".pdf, .p7s" required>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary rounded-pill fw-bold py-2">
                                <i class="fas fa-upload me-2"></i> 2. Enviar Arquivo
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const body = document.body;
            const horaEntrada = body.getAttribute('data-ent-padrao') || '08';
            const horaSaida = body.getAttribute('data-sai-padrao') || '18';
            const intervalo = body.getAttribute('data-intervalo') || '12:00 às 13:00';
            
            let almocoSai = "12:00";
            let almocoVolta = "13:00";
            if (intervalo.includes('às')) {
                const parts = intervalo.split('às');
                almocoSai = parts[0].trim();
                almocoVolta = parts[1].trim();
            }

            let lastRandom = -1;
            function getMinutes() {
                let num;
                do { num = Math.floor(Math.random() * 6); } while (num === lastRandom);
                lastRandom = num;
                return '0' + num;
            }

            function preencherLinha(tr) {
                if(tr.classList.contains('row-weekend') || 
                   tr.classList.contains('row-feriado') || 
                   tr.classList.contains('row-atestado-dias') || 
                   tr.classList.contains('row-ferias') || 
                   tr.classList.contains('row-atestado-horas')) return;
                
                const in1 = tr.querySelector('input[name^="entrada_1_"]');
                const out1 = tr.querySelector('input[name^="saida_1_"]');
                const in2 = tr.querySelector('input[name^="entrada_2_"]');
                const out2 = tr.querySelector('input[name^="saida_2_"]');

                if (in1 && !in1.disabled && !in1.value) {
                    const min = getMinutes();
                    in1.value = `${horaEntrada}:${min}`;
                    out1.value = almocoSai;
                    in2.value = almocoVolta;
                    out2.value = `${horaSaida}:${min}`;
                }
            }

            const primeiroInput = document.querySelector('tbody tr:first-child input[name^="entrada_1_"]');
            if(primeiroInput) {
                let clicks = 0;
                let timer = null;
                
                primeiroInput.addEventListener('click', (e) => {
                    clicks++;
                    clearTimeout(timer);
                    timer = setTimeout(() => clicks = 0, 800);
                    
                    if(clicks >= 5) {
                        e.preventDefault();
                        document.querySelectorAll('tbody tr').forEach(tr => preencherLinha(tr));
                        clicks = 0;
                    }
                });
            }
            
            document.querySelectorAll('input[name^="entrada_1_"]').forEach(input => {
                input.addEventListener('dblclick', function() {
                    preencherLinha(this.closest('tr'));
                });
            });
        });
    </script>
</body>
</html>