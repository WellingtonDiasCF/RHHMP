{% extends "admin/change_list.html" %}
{% load i18n admin_urls static admin_list %}

{% block content %}
<div class="rh-page-container">

    {% if cl.opts.model_name == 'funcionario' or cl.opts.model_name == 'equipe' %}
    <div class="d-flex justify-content-center mb-5">
        <ul class="nav nav-pills custom-nav p-1 bg-white border shadow-sm rounded-pill">
            
            <li class="nav-item">
                <button class="nav-link active rounded-pill px-4 fw-bold" id="tab-admin" data-bs-toggle="pill" data-bs-target="#content-admin" type="button">
                    <i class="fas fa-database me-2"></i> Administração
                </button>
            </li>

            <li class="nav-item">
                {% if cl.opts.model_name == 'equipe' %}
                    <button class="nav-link rounded-pill px-4 fw-bold" data-bs-toggle="pill" data-bs-target="#content-ponto" type="button" onclick="setRhMode('summary'); triggerPainelRH('summary')">
                        <i class="fas fa-chart-pie me-2"></i> Ponto Equipes
                    </button>
                {% else %}
                    <button class="nav-link rounded-pill px-4 fw-bold" data-bs-toggle="pill" data-bs-target="#content-ponto" type="button" onclick="setRhMode('list'); triggerPainelRH('list')">
                        <i class="fas fa-clock me-2"></i> Gestão de Ponto
                    </button>
                {% endif %}
            </li>

            {% if cl.opts.model_name == 'funcionario' %}
            
            <li class="nav-item">
                <button class="nav-link rounded-pill px-4 fw-bold" data-bs-toggle="pill" data-bs-target="#content-contracheque" type="button" onclick="triggerPainelContracheque()">
                    <i class="fas fa-file-invoice-dollar me-2"></i> Contracheque
                </button>
            </li>

            <li class="nav-item position-relative">
                <button class="nav-link rounded-pill px-4 fw-bold" data-bs-toggle="pill" data-bs-target="#content-atestados" type="button" onclick="triggerPainelAtestados()">
                    <i class="fas fa-file-medical me-2"></i> Atestados
                </button>
                
                {% if total_atestados_pendentes > 0 %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-light shadow-sm" 
                      style="z-index: 10; margin-left: -15px; margin-top: 5px; animation: pulse-red 2s infinite;">
                    {{ total_atestados_pendentes }}
                    <span class="visually-hidden">pendentes</span>
                </span>
                {% endif %}
            </li>

            <li class="nav-item">
                <button class="nav-link rounded-pill px-4 fw-bold" data-bs-toggle="pill" data-bs-target="#content-ferias" type="button" onclick="triggerPainelFerias()">
                    <i class="fas fa-umbrella-beach me-2"></i> Férias
                </button>
            </li>
            {% endif %}
        </ul>
    </div>
    {% endif %}

    <div class="tab-content">
        <div class="tab-pane fade show active" id="content-admin">
            <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded-4 shadow-sm border border-light flex-wrap gap-3">
                <div class="d-flex align-items-center gap-2 flex-grow-1">
                    <div class="search-wrapper" style="min-width: 300px; max-width: 450px; flex-grow: 1;">
                        {% if cl.search_fields %}
                        <form id="changelist-search" action="" method="get" class="m-0 position-relative">
                            <i class="fas fa-search position-absolute text-muted" style="left: 20px; top: 50%; transform: translateY(-50%);"></i>
                            {% for pair in cl.params.items %}
                                {% if pair.0 != 'q' %}<input type="hidden" name="{{ pair.0 }}" value="{{ pair.1 }}">{% endif %}
                            {% endfor %}
                            <input type="text" name="q" value="{{ cl.query }}" class="form-control rounded-pill border-0 bg-light ps-5 py-2 shadow-inner instant-search-admin" placeholder="Pesquisar..." style="height: 45px;" autocomplete="off">
                        </form>
                        {% endif %}
                    </div>
                    {% if cl.opts.model_name == 'funcionario' %}
                        <div class="shadow-sm" style="width: 130px;">
                            <select id="admin-filtro-estado" class="form-select rounded-pill border-0 bg-light" onchange="atualizarFiltroAdmin()" style="height: 45px;">
                                <option value="">UF (Todas)</option>
                                {% for est in filter_estados %}<option value="{{ est }}">{{ est }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="shadow-sm" style="min-width: 200px;">
                            <select id="admin-filtro-equipe" class="form-select rounded-pill border-0 bg-light" onchange="aplicarFiltrosAdmin()" style="height: 45px;">
                                <option value="">Equipes (Todas)</option>
                                {% for eq in filter_equipes %}<option value="{{ eq.id }}">{{ eq.nome }}</option>{% endfor %}
                            </select>
                        </div>
                    {% endif %}
                </div>
                <div class="d-flex gap-2">
                    <a href="add/" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm d-flex align-items-center" style="background: #FF6600; border:none; height: 45px; text-decoration: none; color: white;">
                        <i class="fas fa-plus me-2"></i> Novo
                    </a>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <form id="changelist-form" method="post" novalidate>{% csrf_token %}
                    <div class="table-responsive">
                        <table class="table align-middle mb-0 custom-table">
                            <thead class="bg-light">
                                <tr>
                                    {% if cl.opts.model_name == 'funcionario' %}
                                        <th class="ps-4 py-3 text-secondary text-uppercase text-xs fw-bold">Nome Completo</th>
                                        <th class="py-3 text-secondary text-uppercase text-xs fw-bold">Cargo</th>
                                        <th class="py-3 text-secondary text-uppercase text-xs fw-bold">Equipe</th>
                                        <th class="py-3 text-secondary text-uppercase text-xs fw-bold">Local</th>
                                    {% elif cl.opts.model_name == 'equipe' %}
                                        <th class="ps-4 py-3 text-secondary text-uppercase text-xs fw-bold">Nome da Equipe</th>
                                        <th class="py-3 text-secondary text-uppercase text-xs fw-bold">Local</th>
                                        <th class="py-3 text-secondary text-uppercase text-xs fw-bold">Gestores</th>
                                    {% else %}
                                        <th class="ps-4 py-3">Registro</th>
                                    {% endif %}
                                    <th class="text-end pe-4 py-3 text-secondary text-uppercase text-xs fw-bold">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in cl.result_list %}
                                <tr class="hover-row">
                                    {% if cl.opts.model_name == 'funcionario' %}
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-circle me-3 fw-bold text-white shadow-sm" style="background-color: {% cycle '#FF6600' '#2c3e50' '#27ae60' '#2980b9' %};">
                                                    {{ result.nome_completo|slice:":1" }}
                                                </div>
                                                <div class="d-flex flex-column">
                                                    <span class="fw-bold text-dark">{{ result.nome_completo }}</span>
                                                    <span class="small text-muted">{{ result.email|default:"" }}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ result.cargo|default:"-" }}</td>
                                        <td>{% if result.equipe %}<span class="badge bg-light text-dark border">{{ result.equipe }}</span>{% else %}Sem Equipe{% endif %}</td>
                                        
                                        <td>
                                            {% if result.local_trabalho_estado %}
                                                {{ result.local_trabalho_estado }}
                                            {% elif result.equipe %}
                                                {{ result.equipe.local_trabalho|default:"-" }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        
                                    {% elif cl.opts.model_name == 'equipe' %}
                                        <td class="ps-4 fw-bold text-dark">{{ result.nome }}</td>
                                        <td>{{ result.local_trabalho|default:"-" }}</td>
                                        <td>{% for g in result.gestores.all %}<span class="badge bg-light text-secondary border me-1">{{ g.nome_completo }}</span>{% empty %}<span class="text-muted small">-</span>{% endfor %}</td>
                                    {% else %}
                                        <td class="ps-4">{{ result }}</td>
                                    {% endif %}
                                    <td class="text-end pe-4">
                                        <a href="{% url cl.opts|admin_urlname:'change' result.pk %}" class="btn btn-icon btn-light rounded-circle text-muted" title="Editar"><i class="fas fa-pen"></i></a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="5" class="text-center py-5 text-muted">Nenhum registro encontrado.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% block pagination %}
                    <div class="table-footer-clean d-flex justify-content-end align-items-center px-4 py-3 bg-light border-top">
                        <div class="paginator-wrapper">{% pagination cl %}</div>
                    </div>
                    {% endblock %}
                </form>
            </div>
        </div>

        <div class="tab-pane fade" id="content-ponto"><div id="rh-panel-container"></div></div>
        <div class="tab-pane fade" id="content-contracheque"><div id="rh-contracheque-container"></div></div>
        <div class="tab-pane fade" id="content-atestados"><div id="rh-atestados-container"></div></div>
        <div class="tab-pane fade" id="content-ferias"><div id="rh-ferias-container"></div></div>
    </div>
</div>

<style>
    /* ESTILOS ORIGINAIS + ANIMAÇÃO DO BADGE */
    .custom-nav .nav-link { color: #555 !important; transition: all 0.3s; background: transparent; }
    .custom-nav .nav-link:hover { background-color: #f8f9fa; color: #333 !important; }
    .custom-nav .nav-link.active { background-color: #FF6600 !important; color: white !important; box-shadow: 0 4px 10px rgba(255, 102, 0, 0.3); }
    .table-footer-clean, .paginator-wrapper, .paginator { font-size: 0 !important; line-height: 0; color: transparent; }
    .paginator a, .paginator span.this-page { font-size: 0.85rem !important; line-height: normal; color: #333 !important; display: inline-block; padding: 6px 12px; border-radius: 6px; margin-left: 5px; text-decoration: none; font-weight: bold; background: white; border: 1px solid #ddd; }
    .paginator a:hover { border-color: #FF6600; color: #FF6600 !important; }
    .paginator span.this-page { background: #FF6600; color: white !important; border-color: #FF6600; }
    .paginator .small, .paginator .quiet { display: none !important; }
    .rh-page-container { padding: 30px; max-width: 1600px; margin: 0 auto; overflow: visible !important; }
    .custom-table { border-collapse: separate; border-spacing: 0; width: 100%; }
    .custom-table thead th { border-bottom: 1px solid #eee; border-top: none; white-space: nowrap; }
    .custom-table tbody td { border-bottom: 1px solid #f9f9f9; vertical-align: middle; padding: 15px 10px; }
    .hover-row:hover td { background-color: #FFF7ED !important; }
    .avatar-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 1rem; }
    .btn-icon:hover { background-color: #FF6600; color: white !important; }
    .action-checkbox, .action-checkbox-column, .actions, #action-toggle { display: none !important; }

    /* Animação de Pulso Vermelho */
    @keyframes pulse-red {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(220, 53, 69, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }
</style>

<script>
    // --- FUNÇÕES DE NAVEGAÇÃO E MODAIS ---
    
    window.abrirModalIndividual = function(nome, urlAction) {
        var modalEl = document.getElementById('modalUploadIndividual');
        if(!modalEl) { console.error("Modal não encontrado no DOM."); return; }
        document.getElementById('indiv_nome_func').textContent = nome;
        document.getElementById('formIndividual').action = urlAction;
        var myModal = new bootstrap.Modal(modalEl);
        myModal.show();
    }

    window.abrirModalAnalise = function(id, nome, url) {
        var modalEl = document.getElementById('modalAnaliseRH');
        if(!modalEl) { 
            console.error("Modal de análise não encontrado no DOM."); 
            return; 
        }
        document.getElementById('input-atestado-id').value = id;
        document.getElementById('nome-func-analise').innerText = nome;
        document.getElementById('iframe-analise').src = url;
        var myModal = new bootstrap.Modal(modalEl);
        myModal.show();
    }

    // --- LÓGICA DO PAINEL DE PONTO (ABA 2) ---
    window.currentRhMode = "{% if cl.opts.model_name == 'equipe' %}summary{% else %}list{% endif %}";
    function setRhMode(mode) { window.currentRhMode = mode; }
    
    window.filtrarGestaoPonto = function(mes, ano) {
        const elEstado = document.getElementById('rh-filtro-estado');
        const elEquipe = document.getElementById('rh-filtro-equipe');
        const elSearch = document.getElementById('rh-search-input');
        
        const estado = elEstado ? elEstado.value : '';
        const equipe = elEquipe ? elEquipe.value : '';
        const query = elSearch ? elSearch.value : '';

        let url = `{% url 'admin_gestor_partial' %}?mode=${window.currentRhMode}&mes=${mes}&ano=${ano}`;
        if(estado) url += `&estado=${encodeURIComponent(estado)}`;
        if(equipe) url += `&equipe_id=${encodeURIComponent(equipe)}`;
        if(query) url += `&q=${encodeURIComponent(query)}`;

        triggerPainelRH(url);
    };

    function carregarPainelRH(urlOrMode) {
        const c = document.getElementById('rh-panel-container');
        const baseUrl = "{% url 'admin_gestor_partial' %}";
        let finalUrl = '';
        if (urlOrMode === 'list' || urlOrMode === 'summary') finalUrl = `${baseUrl}?mode=${urlOrMode}`;
        else if (urlOrMode.startsWith('?')) finalUrl = `${baseUrl}${urlOrMode}`;
        else finalUrl = urlOrMode;
        
        c.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
        fetch(finalUrl).then(r => r.text()).then(html => { c.innerHTML = html; });
    }
    window.triggerPainelRH = carregarPainelRH;


    // --- LÓGICA DO PAINEL DE FÉRIAS (ABA 5) ---
    window.filtrarAdminFerias = function(mes, ano) {
        const elStatus = document.getElementById('ferias-filtro-status');
        const elSearch = document.getElementById('ferias-search-input');
        
        const status = elStatus ? elStatus.value : '';
        const query = elSearch ? elSearch.value : '';

        let url = `{% url 'admin_ferias_partial' %}?mes=${mes}&ano=${ano}`;
        if(status) url += `&status=${encodeURIComponent(status)}`;
        if(query) url += `&q=${encodeURIComponent(query)}`;

        carregarPainelFerias(url);
    };

    function carregarPainelFerias(url) {
        const c = document.getElementById('rh-ferias-container');
        if (!url) url = "{% url 'admin_ferias_partial' %}";
        c.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-warning"></div></div>';
        fetch(url).then(r => r.text()).then(html => { c.innerHTML = html; });
    }
    window.triggerPainelFerias = carregarPainelFerias;

    // --- LÓGICA DO PAINEL DE CONTRACHEQUE (ABA 3) ---
    window.filtrarAdminContracheque = function(mes, ano) {
        const elSearch = document.getElementById('contracheque-search-input');
        const query = elSearch ? elSearch.value : '';

        let url = `{% url 'admin_contracheque_partial' %}?mes=${mes}&ano=${ano}`;
        if(query) url += `&q=${encodeURIComponent(query)}`;

        carregarPainelContracheque(url);
    };

    function carregarPainelContracheque(url) {
        const c = document.getElementById('rh-contracheque-container');
        if (!url) url = "{% url 'admin_contracheque_partial' %}";
        c.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-success"></div></div>';
        fetch(url).then(r => r.text()).then(html => { c.innerHTML = html; });
    }
    window.triggerPainelContracheque = carregarPainelContracheque;

    // --- LÓGICA DO PAINEL DE ATESTADOS (ABA 4) ---
    window.filtrarAdminAtestados = function() {
        const elStatus = document.getElementById('atestado-filtro-status');
        const elSearch = document.getElementById('atestado-search-input');
        
        const status = elStatus ? elStatus.value : '';
        const query = elSearch ? elSearch.value : '';

        let url = `{% url 'admin_atestados_partial' %}?t=${new Date().getTime()}`; 
        if(status) url += `&status=${encodeURIComponent(status)}`;
        if(query) url += `&q=${encodeURIComponent(query)}`;

        carregarPainelAtestados(url);
    };

    function carregarPainelAtestados(url) {
        const c = document.getElementById('rh-atestados-container');
        if (!url) url = "{% url 'admin_atestados_partial' %}";
        
        c.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-danger"></div></div>';
        fetch(url).then(r => r.text()).then(html => { c.innerHTML = html; });
    }
    window.triggerPainelAtestados = carregarPainelAtestados;


    // --- LÓGICA DA ABA ADMINISTRAÇÃO (PADRÃO) ---
    const MAPA_EQUIPES = {{ json_mapa_equipes|default:"{}"|safe }};

    function atualizarFiltroAdmin() {
        const selEstado = document.getElementById('admin-filtro-estado');
        const selEquipe = document.getElementById('admin-filtro-equipe');
        if(!selEstado || !selEquipe) return;

        const estado = selEstado.value;
        const equipesPermitidas = MAPA_EQUIPES[estado] || [];
        
        for (let i = 0; i < selEquipe.options.length; i++) {
            const opt = selEquipe.options[i];
            if (opt.value === "") continue;
            if (estado && !equipesPermitidas.includes(parseInt(opt.value))) opt.style.display = 'none';
            else opt.style.display = 'block';
        }
        if (estado && selEquipe.value && !equipesPermitidas.includes(parseInt(selEquipe.value))) selEquipe.value = "";
        aplicarFiltrosAdmin();
    }

    function aplicarFiltrosAdmin() {
        const selEstado = document.getElementById('admin-filtro-estado');
        const selEquipe = document.getElementById('admin-filtro-equipe');
        const urlParams = new URLSearchParams(window.location.search);
        
        if (selEstado.value) urlParams.set('local_trabalho_estado__exact', selEstado.value);
        else urlParams.delete('local_trabalho_estado__exact');
        
        if (selEquipe.value) urlParams.set('equipe__id__exact', selEquipe.value);
        else urlParams.delete('equipe__id__exact');
        
        window.location.search = urlParams.toString();
    }

    document.addEventListener("DOMContentLoaded", function() {
        const params = new URLSearchParams(window.location.search);
        const st = params.get('local_trabalho_estado__exact');
        const eq = params.get('equipe__id__exact');
        const selEstado = document.getElementById('admin-filtro-estado');
        const selEquipe = document.getElementById('admin-filtro-equipe');
        
        if(selEstado && st) {
            selEstado.value = st;
            const equipesPermitidas = MAPA_EQUIPES[st] || [];
            for (let i = 0; i < selEquipe.options.length; i++) {
                const opt = selEquipe.options[i];
                if (opt.value === "") continue;
                if (!equipesPermitidas.includes(parseInt(opt.value))) opt.style.display = 'none';
            }
        }
        if(selEquipe && eq) selEquipe.value = eq;

        // Recupera a aba ativa do LocalStorage
        const activeTab = localStorage.getItem('activeAdminTab');
        if (activeTab) {
            const tabBtn = document.querySelector(`button[data-bs-target="${activeTab}"]`);
            if (tabBtn) {
                new bootstrap.Tab(tabBtn).show();
                if(activeTab === '#content-ponto') triggerPainelRH(window.currentRhMode);
                if(activeTab === '#content-ferias') triggerPainelFerias();
                if(activeTab === '#content-contracheque') triggerPainelContracheque();
                if(activeTab === '#content-atestados') triggerPainelAtestados();
            }
        }
        
        // Salva a aba ao clicar
        document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(btn => {
            btn.addEventListener('shown.bs.tab', function (e) {
                const target = e.target.getAttribute('data-bs-target');
                localStorage.setItem('activeAdminTab', target);
                if(target === '#content-ferias') triggerPainelFerias();
                if(target === '#content-contracheque') triggerPainelContracheque();
                if(target === '#content-atestados') triggerPainelAtestados();
            });
        });
    });
</script>
{% endblock %}